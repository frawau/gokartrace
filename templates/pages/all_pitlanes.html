{% extends 'layout/sabase.html' %}
{% load driver_tags %}

{% block title %} All Pit Lanes {% endblock %}

{% block content %}
<div style="height: 100vh; width: 100vw; display: flex; align-items: stretch; justify-content: center; margin: 0; padding: 0;">
    <div class="row g-0" style="height: 100vh; width: 100vw; margin: 0; padding: 0;">
        {% for change_lane in change_lanes %}
        <div id="lane-container-{{ change_lane.id }}" class="col" style="height: 100%;">
            <div id="lane-{{ change_lane.id }}" class="d-flex flex-column h-100">
                <div class="text-center bg-dark text-white py-2">
                    <h3>Pit Lane {{ change_lane.lane }}</h3>
                </div>
                <div class="flex-grow-1">
                {% if change_lane.open %}
                    {% if change_lane.driver %}
                        <div class="d-flex flex-column align-items-center h-100" style="background-color: #f0fff0;">
                            <div class="text-center my-3">
                                <span class="display-1 fw-bold">{{ change_lane.driver.team.team.number }}</span>
                            </div>
                            <div class="text-center mb-3">
                                <h2 class="text-primary">{{ change_lane.driver.team.team.team.name }}</h2>
                            </div>
                            <div class="d-flex flex-column align-items-center mt-3">
                                <img src="{{ change_lane.driver.member.mugshot.url }}" alt="Driver Snapshot"
                                    class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                                {% get_weight_penalty change_lane.driver as weight_penalty %}
                                <h2 class="text-dark">{{ change_lane.driver.member.nickname }}</h2>
                                <h3 class="text-dark">Penalty: {{ weight_penalty }} Kg</h3>
                            </div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100" style="background-color: #f0fff0;">
                            <h1 class="text-dark fw-bold">Open</h1>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100" style="background-color: red;">
                        <h1 class="text-warning fw-bold">Closed</h1>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for change_lane in change_lanes %}
        const socket{{ change_lane.lane }} = new WebSocket("ws://" + window.location.host + "/ws/pitlanes/{{ change_lane.lane }}/");
        
        socket{{ change_lane.lane }}.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'lane.update') {
                const laneContainer = document.getElementById("lane-container-{{ change_lane.id }}");
                // Update only the lane content but maintain the column structure
                const newContent = document.createElement('div');
                newContent.innerHTML = data.lane_html;
                
                // Extract the inner content while preserving the column structure
                const laneElement = document.getElementById("lane-{{ change_lane.id }}");
                laneElement.innerHTML = newContent.querySelector("#lane-{{ change_lane.id }}").innerHTML;
            }
        };
        
        socket{{ change_lane.lane }}.onclose = function(event) {
            if (!event.wasClean) {
                setTimeout(function() {
                    window.location.reload();
                }, 3000);
            }
        };
        {% endfor %}
    });
</script>
{% endblock %} 
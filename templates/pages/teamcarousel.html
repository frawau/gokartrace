{% extends "layout/fscontent.html" %}
{% block extra_style %}
    @media (max-width: 768px) {
        .card-title {
            font-size: 2.5rem !important;
        }
        table {
            font-size: 2rem !important;
        }
        th, td {
            padding: 8px !important;
            border: 6px solid #ddd !important;
        }
        table thead tr th:nth-child(3),
        table tbody tr td:nth-child(3) {
            display: none;
        }
        table tbody tr td:nth-child(2) {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        table tbody tr td:nth-child(2)::after{
            content: attr(data-current-session);
        }
    }
{% endblock extra_style %}
{% block main_content %}
        <div class="section container">
        <h2>Round: {{ round.name }}</h2><div class="countdown-timer" id="roundCountdown"
                                                data-started="{{ round.started|date:'U' }}"
                                                data-duration="{{ round.duration.total_seconds }}"
                                                data-is-paused="{% if round.round_pause_set.filter(end__isnull=True).exists %}true{% else %}false{% endif %}">
                                                Time remaining: <span id="countdownDisplay">--:--:--</span>
                                                </div>

            <div id="teamCarousel" class="carousel slide" data-ride="carousel" >
                <div class="carousel-inner">
                    {% for team in round.round_team_set.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}" data-team-id="{{ team.pk }}">
                            <div class="card" style="background-color: transparent;" >
                                <div class="card-body">
                                    <p>Loading...</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
{% endblock main_content %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Set the interval for auto-sliding (7 seconds)
        $('#teamCarousel').carousel({
            interval: 7000,
            pause:false
        });

        $('#teamCarousel').carousel('cycle');


        // Function to refresh the team card on slide change
        function refreshTeamCard(e) {
            var teamId = $(e.relatedTarget).data('team-id');
            var cardBody = $(e.relatedTarget).find('.card-body');

            //Check if teamId is undefined, if so, get it from the active element.
            if(teamId === undefined){
                teamId = $('.carousel-item.active').data('team-id');
                cardBody = $('.carousel-item.active').find('.card-body');
            }

            if (teamId !== undefined) {
                $.ajax({
                    url: '/get_team_card/',
                    data: { team_id: teamId },
                    success: function(data) {
                        cardBody.html(data.html);
                        startTimers();
                    },
                    error: function() {
                        cardBody.html('<p>Error loading team info.</p>');
                    }
                });
            } else {
                console.error("teamId is undefined.");
            }
        }

        // Attach the refresh function to the 'slid.bs.carousel' event
        $('#teamCarousel').on('slid.bs.carousel', refreshTeamCard);

        // Load the first card on page load
        $('#teamCarousel').trigger('slid.bs.carousel');

        function startTimers() {
            $('.timer').each(function() {
                var startTime = $(this).data('start-time');
                var timerElement = $(this);

                if (startTime) {
                    setInterval(function() {
                        var now = new Date().getTime() / 1000;
                        var diff = now - startTime;
                        timerElement.text(formatTime(diff));
                    }, 1000);
                }
            });
        }

        function formatTime(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            var secs = Math.floor(seconds % 60);
            return hours + ":" + (minutes < 10 ? "0" : "") + minutes + ":" + (secs < 10 ? "0" : "") + secs;
        };

        // Countdown functionality
        function updateCountdown() {
            const countdownEl = $('#roundCountdown');
            const displayEl = $('#countdownDisplay');

            if (!countdownEl.data('started')) {
                displayEl.text('Not started');
                return;
            }

            const startTime = countdownEl.data('started') * 1000; // Convert to milliseconds
            const duration = countdownEl.data('duration') * 1000; // Convert to milliseconds
            const now = new Date().getTime();

            // Calculate time elapsed accounting for pauses
            let elapsedTime = now - startTime;
            let pauseTime = 0;

            // This would be populated with pause data from your model
            const pauses = {{ pauses|safe|default:"[]" }};

            pauses.forEach(pause => {
                const pauseStart = new Date(pause.start).getTime();
                const pauseEnd = pause.end ? new Date(pause.end).getTime() : now;
                pauseTime += (pauseEnd - pauseStart);
            });

            // Subtract pause time from elapsed time
            elapsedTime -= pauseTime;

            // Calculate remaining time
            let remainingTime = duration - elapsedTime;

            if (remainingTime <= 0) {
                displayEl.text('00:00:00');
                return;
            }

            // Format remaining time
            const hours = Math.floor(remainingTime / (1000 * 60 * 60));
            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

            displayEl.text(
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0')
            );
        }

        // Update countdown every second
        setInterval(updateCountdown, 1000);
        updateCountdown(); // Initial update

        // Setup WebSocket to listen for pause events
        const roundSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/round/{{ round.id }}/'
        );

        roundSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'round_update') {
                // Update pause status
                $('#roundCountdown').data('is-paused', data.is_paused);
                // Reload pauses data
                location.reload(); // Or use AJAX to refresh just the necessary data
            }
        };
    });
    document.addEventListener('DOMContentLoaded', () => {
        const cells = document.querySelectorAll('table tbody tr td:nth-child(3)');
        cells.forEach(cell => {
            const previousCell = cell.previousElementSibling;
            if (previousCell) {
                previousCell.setAttribute('data-current-session', cell.textContent);
            }
        });
    });
</script>
{% endblock extra_js %}

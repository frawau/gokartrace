{% extends "layout/fscontent.html" %}
{% block extra_style %}
    @media (max-width: 768px) {
        .card-title {
            font-size: 2.5rem !important;
        }
        table {
            font-size: 2rem !important;
        }
        th, td {
            padding: 8px !important;
            border: 2px solid #ddd !important;
        }
        table thead tr th:nth-child(3),
        table tbody tr td:nth-child(3) {
            display: none;
        }
        table tbody tr td:nth-child(2) {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        table tbody tr td:nth-child(2)::after{
            content: attr(data-current-session);
        }
    }
{% endblock extra_style %}
{% block main_content %}
        <div class="section container">
            <h2>Round: {{ round.name }}</h2>

            <div id="teamCarousel" class="carousel slide" data-ride="carousel" >
                <div class="carousel-inner">
                    {% for team in round.round_team_set.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}" data-team-id="{{ team.pk }}">
                            <div class="card" style="background-color: transparent;" >
                                <div class="card-body">
                                    <p>Loading...</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
{% endblock main_content %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Set the interval for auto-sliding (7 seconds)
        $('#teamCarousel').carousel({
            interval: 7000,
            pause:false
        });

        $('#teamCarousel').carousel('cycle');


        // Function to refresh the team card on slide change
        function refreshTeamCard(e) {
            var teamId = $(e.relatedTarget).data('team-id');
            var cardBody = $(e.relatedTarget).find('.card-body');

            //Check if teamId is undefined, if so, get it from the active element.
            if(teamId === undefined){
                teamId = $('.carousel-item.active').data('team-id');
                cardBody = $('.carousel-item.active').find('.card-body');
            }

            if (teamId !== undefined) {
                $.ajax({
                    url: '/get_team_card/',
                    data: { team_id: teamId },
                    success: function(data) {
                        cardBody.html(data.html);
                        startTimers();
                    },
                    error: function() {
                        cardBody.html('<p>Error loading team info.</p>');
                    }
                });
            } else {
                console.error("teamId is undefined.");
            }
        }

        // Attach the refresh function to the 'slid.bs.carousel' event
        $('#teamCarousel').on('slid.bs.carousel', refreshTeamCard);

        // Load the first card on page load
        $('#teamCarousel').trigger('slid.bs.carousel');

        function startTimers() {
            $('.timer').each(function() {
                var startTime = $(this).data('start-time');
                var timerElement = $(this);

                if (startTime) {
                    setInterval(function() {
                        var now = new Date().getTime() / 1000;
                        var diff = now - startTime;
                        timerElement.text(formatTime(diff));
                    }, 1000);
                }
            });
        }

        function formatTime(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            var secs = Math.floor(seconds % 60);
            return hours + ":" + (minutes < 10 ? "0" : "") + minutes + ":" + (secs < 10 ? "0" : "") + secs;
        }
    });
    document.addEventListener('DOMContentLoaded', () => {
        const cells = document.querySelectorAll('table tbody tr td:nth-child(3)');
        cells.forEach(cell => {
            const previousCell = cell.previousElementSibling;
            if(previousCell){
                previousCell.setAttribute('data-current-session', cell.textContent);
            }
        });
    });
</script>
{% endblock extra_js %}

{% extends "layout/fscontent.html" %}
{% load duration_filters %}
{% block extra_style %}
    @media (max-width: 768px) {
        .card-title {
            font-size: 2.5rem !important;
        }
        table {
            font-size: 2rem !important;
        }
        th, td {
            padding: 8px !important;
            border: 6px solid #ddd !important;
        }
        table thead tr th:nth-child(3),
        table tbody tr td:nth-child(3) {
            display: none;
        }
        table tbody tr td:nth-child(2) {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        table tbody tr td:nth-child(2)::after{
            content: attr(data-current-session);
        }
    }
{% endblock extra_style %}
{% block main_content %}
<div class="section container">
        {% if round is None %}
            <h2> Hu?</h2>
                <div id="teamCarousel" class="carousel slide" data-ride="carousel" >
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <div class="card" style="background-color: transparent;" >
                                <div class="card-body">
                                    <h1>No race today</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        {% else %}
            <h2 class="countdown-timer" id="roundCountdown" data-remaining="{{ round|duration_difference_seconds|default:"0" }}" data-is-paused="{{ round|round_is_paused }}">Round: {{ round.name }} &nbsp;&nbsp;Time remaining: <span id="countdownDisplay">--:--:--</span></h2>

                <div id="teamCarousel" class="carousel slide" data-ride="carousel" >
                    <div class="carousel-inner">
                        {% for team in round.round_team_set.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}" data-team-id="{{ team.pk }}">
                                <div class="card" style="background-color: transparent;" >
                                    <div class="card-body">
                                        <p>Loading...</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
        {% endif %}
</div>
{% endblock main_content %}

{% block extra_js %}
<script>
{% if round is not None %}

    // Store page load time globally to calculate elapsed time
    let pageLoadTime = new Date().getTime();
    let activeDrivers = {};
    let isPaused = {{ round|round_is_paused|lower }};  // Get initial pause state
    let pauseStartTime = null;
    let totalPausedTime = 0;

    $(document).ready(function() {
        // Set the interval for auto-sliding (7 seconds)
        $('#teamCarousel').carousel({
            interval: 7000,
            pause: false
        });

        $('#teamCarousel').carousel('cycle');

        // Function to refresh the team card on slide change
        function refreshTeamCard(e) {
            var teamId = $(e.relatedTarget).data('team-id');
            var cardBody = $(e.relatedTarget).find('.card-body');

            //Check if teamId is undefined, if so, get it from the active element.
            if(teamId === undefined){
                teamId = $('.carousel-item.active').data('team-id');
                cardBody = $('.carousel-item.active').find('.card-body');
            }

            if (teamId !== undefined) {
                $.ajax({
                    url: '/get_team_card/',
                    data: { team_id: teamId },
                    success: function(data) {
                        cardBody.html(data.html);
                        initializeDriverTimers();
                    },
                    error: function() {
                        cardBody.html('<p>Error loading team info.</p>');
                    }
                });
            } else {
                console.error("teamId is undefined.");
            }
        }

        // Attach the refresh function to the 'slid.bs.carousel' event
        $('#teamCarousel').on('slid.bs.carousel', refreshTeamCard);

        // Load the first card on page load
        $('#teamCarousel').trigger('slid.bs.carousel');

        function initializeDriverTimers() {
            // Clear previous active drivers when changing slides
            activeDrivers = {};

            // Find session and total time elements
            $('.card-body table tbody tr').each(function() {
                const row = $(this);
                const driverName = row.find('td:first-child').text().trim();
                const sessionTimeCell = row.find('#sessiontime');
                const totalTimeCell = row.find('#totaltime');

                // Only process rows with the active IDs
                if (sessionTimeCell.length && totalTimeCell.length) {
                    // Store initial times (convert from "HH:MM:SS" to seconds)
                    const sessionTimeText = sessionTimeCell.text().trim();
                    const totalTimeText = totalTimeCell.text().trim();

                    // Parse initial times into seconds
                    const sessionSeconds = parseTimeToSeconds(sessionTimeText);
                    const totalSeconds = parseTimeToSeconds(totalTimeText);

                    // Store start time relative to page load for active drivers
                    activeDrivers[driverName] = {
                        sessionSeconds,
                        totalSeconds,
                        startTime: new Date().getTime()
                    };

                    // Set data attribute for mobile view
                    totalTimeCell.attr('data-current-session', sessionTimeText);
                }
            });

            // Start updating active driver times
            updateDriverTimes();
        }

        function parseTimeToSeconds(timeStr) {
            if (!timeStr || timeStr === '') return 0;

            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return hours.toString().padStart(2, '0') + ':' +
                   minutes.toString().padStart(2, '0') + ':' +
                   secs.toString().padStart(2, '0');
        }

        function updateDriverTimes() {
            // Only update if not paused
            if (!isPaused) {
                const now = new Date().getTime();

                $('.card-body table tbody tr').each(function() {
                    const row = $(this);
                    const driverName = row.find('td:first-child').text().trim();
                    const sessionTimeCell = row.find('#sessiontime');
                    const totalTimeCell = row.find('#totaltime');

                    // Only update cells with the specific IDs
                    if (sessionTimeCell.length && totalTimeCell.length && activeDrivers[driverName]) {
                        const driverData = activeDrivers[driverName];
                        const elapsedSeconds = Math.floor((now - driverData.startTime - totalPausedTime) / 1000);

                        // Update session time with seconds precision
                        const newSessionSeconds = driverData.sessionSeconds + elapsedSeconds;
                        sessionTimeCell.text(formatTime(newSessionSeconds));

                        // Update total time with seconds precision
                        const newTotalSeconds = driverData.totalSeconds + elapsedSeconds;
                        totalTimeCell.text(formatTime(newTotalSeconds));

                        // Update data attribute for mobile view
                        totalTimeCell.attr('data-current-session', formatTime(newSessionSeconds));
                        }
                    });
                }

            // Update every second
            setTimeout(updateDriverTimes, 1000);
        }

        function updateCountdown() {
            const countdownEl = $('#roundCountdown');
            if (countdownEl.length) {
                countdownEl.attr('data-is-paused', data.is_paused);
            }
            const displayEl = $('#countdownDisplay');
            const remainingSeconds = parseInt(countdownEl.attr('data-remaining'), 10);
            const isPaused = countdownEl.attr('data-is-paused') === 'true';

            // Check if we have a valid number
            if (isNaN(remainingSeconds)) {
                displayEl.text('--:--:--');
                return;
            }

            let remainingTime = remainingSeconds * 1000; // Convert to ms

            if (!isPaused) {
                // Only count down if not paused
                const now = new Date().getTime();
                const elapsedSincePageLoad = now - pageLoadTime;
                remainingTime = Math.max(0, remainingTime - elapsedSincePageLoad);
            }

            // Format time
            const hours = Math.floor(remainingTime / (1000 * 60 * 60));
            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

            displayEl.text(
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0')
            );
        }

        // Start countdown immediately
        updateCountdown();
        // Update countdown every second
        setInterval(updateCountdown, 1000);

        // Setup WebSocket to listen for pause events and driver updates
        const roundSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/roundpause/{{ round.id }}/'
        );

        roundSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'round_update') {
                    // Update round pause status in the countdown element
                    $('#roundCountdown').attr('data-is-paused', data.is_paused);

                    const now = new Date().getTime();

                    // Handle pause state changes
                    if (data.is_paused && !isPaused) {
                        // Race just got paused
                        console.log("Race paused - timers stopped");
                        pauseStartTime = now;
                    }
                    else if (!data.is_paused && isPaused) {
                        // Race just resumed
                        console.log("Race resumed - timers continue");

                        // Calculate how long we were paused
                        if (pauseStartTime !== null) {
                            const pauseDuration = now - pauseStartTime;
                            totalPausedTime += pauseDuration;
                            pauseStartTime = null;
                        }
                    }

                    // Update the pause state
                    isPaused = data.is_paused;

                    // Update remaining time if provided
                    if (data.remaining_seconds !== undefined) {
                        $('#roundCountdown').attr('data-remaining', data.remaining_seconds);
                    }
                }
                else if (data.type === 'driver_update') {
                    // Refresh the team card if there's a driver update
                    $('#teamCarousel').trigger('slid.bs.carousel');
                }
            } catch (error) {
                console.error("Error handling WebSocket message:", error);
            }
        };
    });

    document.addEventListener('DOMContentLoaded', () => {
        const cells = document.querySelectorAll('table tbody tr td:nth-child(3)');
        cells.forEach(cell => {
            const previousCell = cell.previousElementSibling;
            if (previousCell) {
                previousCell.setAttribute('data-current-session', cell.textContent);
            }
        });
    });
{% endif %}
</script>
{% endblock extra_js %}

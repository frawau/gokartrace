{% extends "layout/content.html" %}
{% load round_tags %}

{% block main_content %}
<div class="container">
    <h1>Round Information</h1>

    <form method="get" id="round-form">
        <div class="form-group">
            <label for="round-select">Select Round:</label>
            <select class="form-control" id="round-select" name="round_id" onchange="this.form.submit()">
                {% for round in rounds %}
                    <option value="{{ round.id }}" {% if round.id == selected_round_id %}selected{% endif %}>
                        {{ round.name }} ({{ round.start|date:"Y-m-d" }})
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    {% if round_teams %}
    <div class="round-teams mt-4">
        <table class="table table-hover round-stats-table">
            <thead>
                <tr>
                    <th style="width: 8px;"></th>
                    <th>Number</th>
                    <th>Team Name</th>
                    <th>{% if selected_round.ended %}Changes{% endif %}</th>
                </tr>
            </thead>
            <tbody>
                {% for team in round_teams %}
                {% check_team_transgression team as team_has_transgression %}
                <tr class="team-row depth-0" data-team-id="{{ team.id }}">
                    <td class="color-label" style="background-color:
                        {% if selected_round.ended %}
                            {% if team_has_transgression %}#ff5252{% else %}#4caf50{% endif %}
                        {% else %}transparent{% endif %}">
                    </td>
                    <td>{{ team.number }}</td>
                    <td>{{ team.name }}</td>
                    <td>{% if selected_round.ended %}{{ team.completed_sessions_count }}{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>

            {% for team in round_teams %}
            {% check_team_transgression team as team_has_transgression %}
            <tbody class="driver-container team-{{ team.id }}-container" style="display: none;">
                {% for member in team.members %}
                {% check_driver_transgression member as driver_has_transgression %}
                <tr class="driver-row depth-1 team-{{ team.id }}" data-member-id="{{ member.id }}">
                    <td class="color-label" style="background-color:
                        {% if selected_round.ended %}
                            {% if team_has_transgression %}#ff5252{% else %}#4caf50{% endif %}
                        {% else %}transparent{% endif %}">
                    </td>
                    <td style="color: {% if driver_has_transgression %}#ff8080{% else %}#e6e6fa{% endif %}">
                        {{ member.time_spent|format_time }}
                    </td>
                    <td>{{ member.member.nickname }}</td>
                    <td>{{ member.sessions_count }}</td>
                </tr>
                {% endfor %}
            </tbody>

            {% if selected_round.ended %}
            {% for member in team.members %}
            <tbody class="session-container member-{{ member.id }}-container" style="display: none;">
                {% for session in member.all_sessions %}
                <tr class="session-row depth-2 member-{{ member.id }} team-{{ team.id }}">
                    <td class="color-label" style="background-color:
                        {% if team_has_transgression %}#ff5252{% else %}#4caf50{% endif %}">
                    </td>
                    <td>{{ session.duration|format_time }}</td>
                    <td colspan="2">{{ session.start|date:"Y-m-d H:i:s" }}</td>
                </tr>
                {% endfor %}
            </tbody>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">No round selected or no teams found.</div>
    {% endif %}
</div>
{% endblock main_content %}

{% block extra_js %}
<style>
    /* Base styling */
    .round-stats-table {
        background-color: rgba(40, 40, 50, 0.85);
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .round-stats-table th {
        background-color: rgba(30, 30, 40, 0.9);
        color: #e6e6fa !important;
        font-weight: 600;
        letter-spacing: 0.5px;
        border-bottom: 2px solid rgba(80, 80, 100, 0.6);
        padding: 12px 15px;
    }

    /* Row levels styling */
    .round-stats-table tr.depth-0 {
        background-color: rgba(50, 50, 70, 0.8);
    }

    .round-stats-table tr.depth-0:nth-child(odd) {
        background-color: rgba(55, 55, 75, 0.8);
    }

    .round-stats-table tr.depth-1 {
        background-color: rgba(60, 60, 80, 0.75);
    }

    .round-stats-table tr.depth-1:nth-child(odd) {
        background-color: rgba(65, 65, 85, 0.75);
    }

    .round-stats-table tr.depth-2 {
        background-color: rgba(70, 70, 90, 0.7);
    }

    .round-stats-table tr.depth-2:nth-child(odd) {
        background-color: rgba(75, 75, 95, 0.7);
    }

    /* Text and content styling */
    .round-stats-table td {
        color: #e6e6fa !important;
        border-top: 1px solid rgba(80, 80, 100, 0.3);
        padding: 10px 15px;
    }

    .color-label {
        width: 8px;
        padding: 0 !important;
        border-right: none !important;
    }

    .team-row, .driver-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .team-row:hover, .driver-row:hover {
        background-color: rgba(100, 100, 130, 0.6) !important;
    }

    /* Animation styles */
    .driver-container, .session-container {
        transition: opacity 0.3s ease;
    }

    .driver-row, .session-row {
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }

    .driver-row.show, .session-row.show {
        opacity: 1;
    }

    /* Forms styling */
    #round-form label {
        color: #e6e6fa !important;
        font-weight: 500;
    }

    #round-select {
        color: #e6e6fa !important;
        background-color: rgba(40, 40, 60, 0.9) !important;
        border: 1px solid rgba(100, 100, 140, 0.4);
        border-radius: 4px;
        padding: 8px 12px;
    }

    #round-select option {
        color: #e6e6fa !important;
        background-color: #2d2d3d !important;
    }

    body .card-body .form-control,
    body .card .card-body .form-control,
    body .form-group .form-control {
        color: #e6e6fa !important;
    }

    h1 {
        color: #e6e6fa !important;
        margin-bottom: 25px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Icon styling for expandable rows */
    .expand-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 8px;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .expanded .expand-icon {
        transform: rotate(90deg);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add expand icon to team rows
    document.querySelectorAll('.team-row').forEach(row => {
        const firstCell = row.querySelector('td:nth-child(2)');
        if (firstCell) {
            const expandIcon = document.createElement('span');
            expandIcon.classList.add('expand-icon');
            expandIcon.innerHTML = 'â–¶';
            if (firstCell.firstChild) {
                firstCell.insertBefore(expandIcon, firstCell.firstChild);
            } else {
                firstCell.appendChild(expandIcon);
            }
        }
    });

    // Toggle team members when clicking on a team row
    document.querySelectorAll('.team-row').forEach(row => {
        row.addEventListener('click', function() {
            const teamId = this.getAttribute('data-team-id');
            const driverContainer = document.querySelector(`.team-${teamId}-container`);

            // Toggle expanded class for icon rotation
            this.classList.toggle('expanded');

            // Toggle display with slide animation
            if (driverContainer.style.display === 'none') {
                driverContainer.style.display = 'table-row-group';
                // Add show class after a small delay to trigger the animation
                setTimeout(() => {
                    const driverRows = driverContainer.querySelectorAll('.driver-row');
                    driverRows.forEach(dr => dr.classList.add('show'));
                }, 10);

                // Hide any open session containers
                document.querySelectorAll('.session-container').forEach(sc => {
                    sc.style.display = 'none';
                    sc.querySelectorAll('.session-row').forEach(sr => sr.classList.remove('show'));
                });

                // Hide other team containers
                document.querySelectorAll('.driver-container').forEach(dc => {
                    if (dc !== driverContainer) {
                        dc.style.display = 'none';
                        dc.querySelectorAll('.driver-row').forEach(dr => dr.classList.remove('show'));
                    }
                });

                // Remove expanded class from other team rows
                document.querySelectorAll('.team-row').forEach(tr => {
                    if (tr !== this) {
                        tr.classList.remove('expanded');
                    }
                });
            } else {
                const driverRows = driverContainer.querySelectorAll('.driver-row');
                driverRows.forEach(dr => dr.classList.remove('show'));

                // Hide session containers associated with this team
                document.querySelectorAll(`.session-container`).forEach(container => {
                    container.style.display = 'none';
                    container.querySelectorAll('.session-row').forEach(sr => sr.classList.remove('show'));
                });

                // Hide driver container after animation completes
                setTimeout(() => {
                    driverContainer.style.display = 'none';
                }, 300);
            }
        });
    });

    // Toggle sessions when clicking on a driver row
    document.querySelectorAll('.driver-row').forEach(driverRow => {
        driverRow.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering the team row click

            const memberId = this.getAttribute('data-member-id');
            const sessionContainer = document.querySelector(`.member-${memberId}-container`);

            if (sessionContainer) {
                // Toggle expanded class for icon
                this.classList.toggle('expanded');

                // Toggle session rows with animation
                if (sessionContainer.style.display === 'none') {
                    sessionContainer.style.display = 'table-row-group';

                    // Hide other session containers
                    document.querySelectorAll('.session-container').forEach(sc => {
                        if (sc !== sessionContainer) {
                            sc.style.display = 'none';
                            sc.querySelectorAll('.session-row').forEach(sr => sr.classList.remove('show'));
                        }
                    });

                    // Show the session rows with animation
                    setTimeout(() => {
                        const sessionRows = sessionContainer.querySelectorAll('.session-row');
                        sessionRows.forEach(sr => sr.classList.add('show'));
                    }, 10);
                } else {
                    const sessionRows = sessionContainer.querySelectorAll('.session-row');
                    sessionRows.forEach(sr => sr.classList.remove('show'));

                    setTimeout(() => {
                        sessionContainer.style.display = 'none';
                    }, 300);
                }
            }
        });
    });

    // WebSocket connection
    if (document.querySelector('#round-select').value) {
        const roundId = document.querySelector('#round-select').value;
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const roundSocket = new WebSocket(
            `${ws_scheme}://${window.location.host}/ws/round/${roundId}/`
        );

        roundSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (!data.session_update) {
                // Round updates
                if (data.ended !== undefined) {
                    if (data.ended) {
                        location.reload(); // Reload when round ends
                    }
                }
            } else {
                // Session updates
                location.reload(); // Simple approach for now
            }
        };

        roundSocket.onclose = function(e) {
            console.error('Round socket closed unexpectedly');
        };
    }
});
</script>
{% endblock extra_js %}

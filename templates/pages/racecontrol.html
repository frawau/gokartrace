{% extends 'layout/sabase.html' %}
{% load static duration_filters timer_tags %}

{% block content %}
<div class="container-fluid" style="height: 100vh; overflow: hidden;">
    <div class="row" style="height: 10%;">
        <div class="col-12 text-center">
            <h1>
                {% if round %}
                    {{ round.name }}&nbsp;&nbsp;Remaining Time: {% timer_widget "race-control-countdown" "countdownDisplay" round %}
                {% else %}
                    Race Control - No Active Round
                {% endif %}
            </h1>
        </div>
    </div>
    <div class="row" style="height: 100%;">
        <div class="col-md-8" style="height: 100%;">
            <div class="card" style="height: 100%; background-color: transparent;">
                <div class="card-body d-flex flex-column" style="height: 100%;">
                    <div class="d-flex w-100" style="height: 20%;">
                        <div id="race-control-buttons" style="width: 50%;" class="p-2 d-flex align-items-center flex-wrap" {% if round %}data-round-id="{{ round.id }}"{% endif %}>
                            {% csrf_token %}

                            {% if round %}
                                {# --- Pre Race Check Button --- #}
                                {% if not round.ready and not round.started and not round.ended %}
                                <button id="preRaceCheckButton" class="btn btn-warning btn-lg me-2 mb-2 race-action-btn"
                                        data-action="pre_check"
                                        data-url="{% url 'preracecheck' %}">
                                    <i class="fas fa-tasks me-1"></i> Pre Race Check
                                </button>
                                {% endif %}

                                {# --- Start Button --- #}
                                {% if round.ready and not round.started and not round.ended %}
                                <button id="startButton" class="btn btn-success btn-lg me-2 mb-2 race-action-btn"
                                        data-action="start"
                                        data-url="{% url 'race_start' %}">
                                    <i class="fas fa-play me-1"></i> Start Race
                                </button>
                                {% endif %}

                                {# --- Pause Button --- #}
                                {% if round.started and not round.is_paused and not round.ended %}
                                <button id="pauseButton" class="btn btn-warning btn-lg me-2 mb-2 race-action-btn"
                                        data-action="pause"
                                        data-url="{% url 'racepaused' %}">
                                    <i class="fas fa-pause me-1"></i> Pause Race
                                </button>
                                {% endif %}

                                {# --- Resume Button --- #}
                                {% if round.started and round.is_paused and not round.ended %}
                                <button id="resumeButton" class="btn btn-info btn-lg me-2 mb-2 race-action-btn"
                                        data-action="resume"
                                        data-url="{% url 'racerestart' %}">
                                    <i class="fas fa-play-circle me-1"></i> Resume Race
                                </button>
                                {% endif %}

                                {# --- End Button --- #}
                                {% if round.started and not round.ended %}
                                <button id="endButton" class="btn btn-danger btn-lg me-2 mb-2 race-action-btn"
                                        data-action="end"
                                        data-url="{% url 'endofrace' %}">
                                    <i class="fas fa-stop me-1"></i> End Race
                                </button>
                                {% endif %}

                                {# --- False Start Button --- #}
                                {% if round.started and not round.ended %} {# Adjust condition if needed #}
                                <button id="falseStartButton" class="btn btn-secondary btn-lg me-2 mb-2 race-action-btn"
                                        data-action="false_start"
                                        data-url="{% url 'falsestart' %}">
                                    <i class="fas fa-undo me-1"></i> False Start
                                </button>
                                {% endif %}

                                {# --- False Restart Button (Optional) --- #}
                                {% if round.started and round.is_paused and not round.ended %} {# Adjust condition if needed #}
                                 <button id="falseRestartButton" class="btn btn-secondary btn-lg me-2 mb-2 race-action-btn"
                                         data-action="false_restart"
                                         data-url="{% url 'falserestart' %}">
                                     <i class="fas fa-history me-1"></i> False Restart
                                 </button>
                                {% endif %}

                            {% else %}
                                <p class="text-muted">No round active.</p>
                            {% endif %}
                        </div>

                        <div style="width: 50%;" class="p-2" id="teamsListContainer">
                             <div class="card h-100" id="emptyTeamsCard" {% if round and round.ready %}style="display: none;"{% endif %}>
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Teams with No Members</h5>
                                    <button class="btn btn-danger" id="deleteEmptyTeamsBtn">Delete All</button>
                                </div>
                                <div class="card-body overflow-auto" id="emptyTeamsList">
                                    <div class="text-center text-muted" id="emptyTeamsPlaceholder">
                                        Loading teams...
                                    </div>
                                    <ul class="list-group" id="emptyTeamsUL"></ul>
                                </div>
                            </div>

                            <div class="card h-100" id="teamSelectCard" {% if not round or not round.ready %}style="display: none;"{% endif %}>
                                <div class="card-header">
                                    <h5 class="mb-0">Stop & Go Penalty</h5>
                                </div>
                                <div class="card-body overflow-auto">
                                    <select class="form-select mb-2" id="teamSelect" style="font-size: 1.2rem;">
                                        {% for team in round.round_team_set.all %}
                                            <option value="{{ team.id }}">{{ team.team.number }} {{ team.team.team.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-success w-100" id="stopGoButton">Stop&Go</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="w-100 p-2" style="height: 80%;">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">System Messages</h5>
                            </div>
                            <div class="card-body overflow-auto" id="messagesContainer">
                                {% if messages %}
                                    {% for message in messages %}
                                        <div class="alert alert-{{ message.tags }}">
                                            {{ message }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                 </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 d-flex flex-column" style="height: 100%;">
             {% for i in "x"|ljust:lanes %}
                <div id="lane-{{ forloop.counter }}" class="card mb-2" style="flex-grow: 1; background-color: transparent;">Lane {{ forloop.counter }} Loading...</div>
            {% endfor %}
            <div id="changequeue" class="card mb-2" style="flex-grow: 1; background-color: transparent;">Queue Loading...</div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
{# Load the new JS file for button handling #}
<script src="{% static 'js/racecontrol.js' %}"></script>

<script>

    // --- Utility Functions (Keep or move to racecontrol.js) ---
    // Ensure these are defined if used by inline code below
    // function addSystemMessage(message, tag) { /* ... implementation ... */ }
    // function getCookie(name) { /* ... implementation ... */ }
    // function updateEmptyTeamsList(teams) { /* ... implementation ... */ }

    // --- WebSocket Connections (Keep inline if using template vars) ---
    document.addEventListener('DOMContentLoaded', function() {
        {% if round %}
            const roundId = {{ round.id }};
            const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';

            // --- Round Update WebSocket ---
            const roundSocketUrl = `${wsScheme}://${window.location.host}/ws/roundpause/${roundId}/`;
            const roundSocket = createWebSocketWithReconnect(
                roundSocketUrl,
                function(e) { // onmessage
                    try {
                        const data = JSON.parse(e.data);
                        console.log("Round WS received:", data);
                        if (data.type === 'round_update') {
                            // Update timer (timer-widget.js handles this via registry)
                            if (data.remaining_seconds !== undefined && window.timerRegistry && window.timerRegistry.countdownTimers) {
                                 window.timerRegistry.countdownTimers.forEach(timer => {
                                     timer.updateRemainingTime(data.remaining_seconds);
                                 });
                            }
                            // Update pause state for all timers
                            const isPaused = data.is_paused;
                            if (window.timerRegistry && window.timerRegistry.byRoundId && window.timerRegistry.byRoundId[roundId]) {
                                window.timerRegistry.byRoundId[roundId].forEach(timer => {
                                    timer.updatePauseState(isPaused);
                                });
                            }
                            // Update status text display (example)
                            const statusTextEl = document.getElementById('race-status-text');
                            if (statusTextEl) {
                                // This logic might be better if backend sends a 'status_display' string
                                if (data.is_ended) { statusTextEl.textContent = 'Finished'; }
                                else if (data.is_started && isPaused) { statusTextEl.textContent = 'Paused'; }
                                else if (data.is_started) { statusTextEl.textContent = 'Running'; }
                                else { statusTextEl.textContent = 'Not Started'; }
                            }
                            // Consider page reload or HTMX swap for button updates
                            // addSystemMessage("Race state updated.", "info");
                        }
                     } catch (err) {
                        console.error("Error processing round WS message:", err, e.data);
                     }
                },
                null, // onopen
                (e) => addSystemMessage("Round status connection error.", "danger"), // onerror
                (e) => addSystemMessage("Round status connection closed.", e.wasClean ? "info" : "warning") // onclose
            );

            // --- Empty Teams WebSocket ---
            const emptyTeamsSocketUrl = `${wsScheme}://${window.location.host}/ws/empty_teams/`;
            const emptyTeamsSocket = createWebSocketWithReconnect(
                 emptyTeamsSocketUrl,
                 function(e) { // onmessage
                    try {
                        const data = JSON.parse(e.data);
                        if (data.type === 'empty_teams_list') {
                            updateEmptyTeamsList(data.teams); // Assumes function is defined
                        } else if (data.type === 'system_message') {
                            addSystemMessage(data.message, data.tag); // Assumes function is defined
                        }
                    } catch (err) {
                        console.error("Error processing empty teams WS message:", err, e.data);
                    }
                 },
                 function(e) { console.log('Empty Teams WS connected'); }, // onopen
                 function(e) { addSystemMessage("Empty Teams connection error.", "danger"); }, // onerror
                 function(e) { addSystemMessage("Empty Teams connection closed.", e.wasClean ? "info" : "warning"); } // onclose
            );
             // Add event listener for delete button (can be here or in racecontrol.js)
             document.getElementById('deleteEmptyTeamsBtn')?.addEventListener('click', function() {
                 if (confirm('Are you sure you want to delete all teams with no members?')) {
                     emptyTeamsSocket.send(JSON.stringify({'action': 'delete_empty_teams'}));
                 }
             });
             // Add logic for updating list and single delete buttons (needs function updateEmptyTeamsList)


        {% endif %} // end if round
    }); // end DOMContentLoaded

    // Keep helper functions if needed by inline WS code and defined in racecontrol.js
    // Make sure functions like addSystemMessage, getCookie, updateEmptyTeamsList are accessible
    // Easiest is to define them in racecontrol.js outside the DOMContentLoaded listener

</script>

{% endblock extra_js %}
